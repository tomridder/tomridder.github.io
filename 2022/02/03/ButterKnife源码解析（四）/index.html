<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>ButterKnife源码解析（四） | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ButterKnife 8.4.0 源码分析（四）.java文件生成生成.java文件你可以用字符串拼接的笨方法，但是我们的jake大神怎么可能那么弱。人家自己又写了一个库。javapoet ，66666  1compile &amp;#x27;com.squareup:javapoet:1.7.0&amp;#x27;  这里简单的介绍下javapoet  JavaPoet的基本介绍（1）JavaPoet是一款可">
<meta property="og:type" content="article">
<meta property="og:title" content="ButterKnife源码解析（四）">
<meta property="og:url" content="http://example.com/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ButterKnife 8.4.0 源码分析（四）.java文件生成生成.java文件你可以用字符串拼接的笨方法，但是我们的jake大神怎么可能那么弱。人家自己又写了一个库。javapoet ，66666  1compile &amp;#x27;com.squareup:javapoet:1.7.0&amp;#x27;  这里简单的介绍下javapoet  JavaPoet的基本介绍（1）JavaPoet是一款可">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/BKjavapoet.png">
<meta property="article:published_time" content="2022-02-03T12:04:45.000Z">
<meta property="article:modified_time" content="2022-02-04T12:41:55.311Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/BKjavapoet.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-ButterKnife源码解析（四）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/" class="article-date">
  <time datetime="2022-02-03T12:04:45.000Z" itemprop="datePublished">2022-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ButterKnife源码解析（四）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ButterKnife-8-4-0-源码分析（四）"><a href="#ButterKnife-8-4-0-源码分析（四）" class="headerlink" title="ButterKnife 8.4.0 源码分析（四）"></a>ButterKnife 8.4.0 源码分析（四）</h1><h3 id="java文件生成"><a href="#java文件生成" class="headerlink" title=".java文件生成"></a>.java文件生成</h3><p>生成.java文件你可以用字符串拼接的笨方法，但是我们的jake大神怎么可能那么弱。人家自己又写了一个库。javapoet ，66666 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile &#x27;com.squareup:javapoet:1.7.0&#x27;</span><br></pre></td></tr></table></figure>

<p>这里简单的介绍下javapoet </p>
<h4 id="JavaPoet的基本介绍"><a href="#JavaPoet的基本介绍" class="headerlink" title="JavaPoet的基本介绍"></a>JavaPoet的基本介绍</h4><p>（1）JavaPoet是一款可以自动生成Java文件的第三方依赖<br>（2）简洁易懂的API，上手快<br>（3）让繁杂、重复的Java文件，自动化生成，提高工作效率，简化流程</p>
<h4 id="JavaPoet的小试牛刀"><a href="#JavaPoet的小试牛刀" class="headerlink" title="JavaPoet的小试牛刀"></a>JavaPoet的小试牛刀</h4><p>为了展示JavaPoet的能力，这里以自动生成一个全新的MainActivity为例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我在使用JavaPoet的时候，习惯从外向内逐一生成，但是这不是标准,这里可以按照自己的方式来理解和生成.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ClassName activity = ClassName.get(<span class="string">&quot;android.app&quot;</span>, <span class="string">&quot;Activity&quot;</span>);</span><br><span class="line"></span><br><span class="line">    TypeSpec.Builder mainActivityBuilder = TypeSpec.classBuilder(<span class="string">&quot;MainActivity&quot;</span>)</span><br><span class="line">            .addModifiers(Modifier.PUBLIC)</span><br><span class="line">            .superclass(activity);</span><br><span class="line"></span><br><span class="line">    ClassName override = ClassName.get(<span class="string">&quot;java.lang&quot;</span>, <span class="string">&quot;Override&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ClassName bundle = ClassName.get(<span class="string">&quot;android.os&quot;</span>, <span class="string">&quot;Bundle&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ClassName nullable = ClassName.get(<span class="string">&quot;android.support.annotation&quot;</span>, <span class="string">&quot;Nullable&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ParameterSpec savedInstanceState = ParameterSpec.builder(bundle, <span class="string">&quot;savedInstanceState&quot;</span>)</span><br><span class="line">            .addAnnotation(nullable)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    MethodSpec onCreate = MethodSpec.methodBuilder(<span class="string">&quot;onCreate&quot;</span>)</span><br><span class="line">            .addAnnotation(override)</span><br><span class="line">            .addModifiers(Modifier.PROTECTED)</span><br><span class="line">            .addParameter(savedInstanceState)</span><br><span class="line">            .addStatement(<span class="string">&quot;super.onCreate(savedInstanceState)&quot;</span>)</span><br><span class="line">            .addStatement(<span class="string">&quot;setContentView(R.layout.activity_main)&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    TypeSpec mainActivity = mainActivityBuilder.addMethod(onCreate)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    JavaFile file = JavaFile.builder(<span class="string">&quot;com.test&quot;</span>, mainActivity).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        file.writeTo(System.out);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="BKjavapoet.png"></p>
<p>代码以及图通俗易懂，这里就不过多解释。</p>
<h4 id="javapoet在ButterKnife中的使用"><a href="#javapoet在ButterKnife中的使用" class="headerlink" title="javapoet在ButterKnife中的使用"></a>javapoet在ButterKnife中的使用</h4><p>在 process()方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">  Map&lt;TypeElement, BindingClass&gt; targetClassMap = findAndParseTargets(env);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingClass&gt; entry : targetClassMap.entrySet()) &#123;</span><br><span class="line">    TypeElement typeElement = entry.getKey();</span><br><span class="line">    BindingClass bindingClass = entry.getValue();</span><br><span class="line"></span><br><span class="line">    JavaFile javaFile = bindingClass.brewJava();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      javaFile.writeTo(filer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      error(typeElement, <span class="string">&quot;Unable to write binding for type %s: %s&quot;</span>, typeElement, e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历targetClassMap集合，调用每一个类的brewJava()方法，最后返回JavaFile对象，再通过writeTo方法生成java文件。<br>接下来我们就看下bindingClass.brewJava（）方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们可以看到javapoet这个开源库使用了设计模式－builder模式。</span></span><br><span class="line"><span class="comment">// 我们看源码就是看这些模式啦，思想啦，才能提高自己的代码编写能力</span></span><br><span class="line"><span class="comment">//bug少了才有时间干别的呀，哈哈 。。。你懂我的</span></span><br><span class="line"></span><br><span class="line">  <span class="function">JavaFile <span class="title">brewJava</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//参数1:包名</span></span><br><span class="line">   <span class="comment">//参数2:TypeSpec，这个可以生成class ，interface 等java文件</span></span><br><span class="line">    <span class="keyword">return</span> JavaFile.builder(bindingClassName.packageName(), createBindingClass())</span><br><span class="line">    <span class="comment">//注释</span></span><br><span class="line">        .addFileComment(<span class="string">&quot;Generated code from Butter Knife. Do not modify!&quot;</span>)</span><br><span class="line">        .build();  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>主要步骤 </p>
<ol>
<li><p>生成类名 </p>
</li>
<li><p>生成构造函数 </p>
</li>
<li><p>生成unbind方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TypeSpec <span class="title">createBindingClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="number">1.</span> 生成类名</span><br><span class="line">  <span class="comment">//bindingClassName.simpleName() 就是我们在findAndParseTargets方法形成的类的名字：xxx_ViewBinding名字</span></span><br><span class="line">  xxx也就是使用butterknife的类名</span><br><span class="line"></span><br><span class="line">    TypeSpec.Builder result = TypeSpec.classBuilder(bindingClassName.simpleName())</span><br><span class="line">    <span class="comment">//增加类修饰符public</span></span><br><span class="line">        .addModifiers(PUBLIC);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//使用butterknife的类是 final类</span></span><br><span class="line">    TypeName targetType;</span><br><span class="line">    <span class="keyword">if</span> (isFinal) &#123;</span><br><span class="line">     <span class="comment">//增加类修饰符FINAL</span></span><br><span class="line">      result.addModifiers(FINAL);</span><br><span class="line">      targetType = targetTypeName;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//不是final类，增加泛型参数T</span></span><br><span class="line">      targetType = TypeVariableName.get(<span class="string">&quot;T&quot;</span>);</span><br><span class="line">      result.addTypeVariable(TypeVariableName.get(<span class="string">&quot;T&quot;</span>, targetTypeName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果有父类直接继承</span></span><br><span class="line">    <span class="keyword">if</span> (hasParentBinding()) &#123;</span><br><span class="line">result.superclass(ParameterizedTypeName.get(getParentBinding(), targetType));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//增加实现接口</span></span><br><span class="line">      result.addSuperinterface(UNBINDER);</span><br><span class="line">       <span class="comment">//增加成员变量</span></span><br><span class="line">      result.addField(targetType, <span class="string">&quot;target&quot;</span>, isFinal ? PRIVATE : PROTECTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//到这里生成的代码如下：</span></span><br><span class="line">    ／／比如在activity</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinding</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">SimpleActivity</span>&gt; <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> T target;</span><br><span class="line">  ｝</span><br><span class="line">  <span class="comment">//比如在adapter的viewholder中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAdapter</span>$<span class="title">ViewHolder_ViewBinding</span> <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> SimpleAdapter.ViewHolder target;</span><br><span class="line">｝</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 生成构造函数</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bindNeedsView()) &#123;</span><br><span class="line">      <span class="comment">// Add a delegating constructor with a target type + view signature for reflective use.</span></span><br><span class="line">      result.addMethod(createBindingViewDelegateConstructor(targetType));</span><br><span class="line">    &#125;</span><br><span class="line">    result.addMethod(createBindingConstructor(targetType));</span><br><span class="line"><span class="number">3.</span> 生成unbind方法。</span><br><span class="line">    <span class="keyword">if</span> (hasViewBindings() || !hasParentBinding()) &#123;</span><br><span class="line">      result.addMethod(createBindingUnbindMethod(result, targetType));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result.build();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="（一）生成类名"><a href="#（一）生成类名" class="headerlink" title="（一）生成类名"></a>（一）生成类名</h4><p>代码里注释的比较详细了</p>
<h4 id="（二）生成构造函数"><a href="#（二）生成构造函数" class="headerlink" title="（二）生成构造函数"></a>（二）生成构造函数</h4><p>主要是createBindingConstructor 方法，主要是对成员变量赋值，以及设置监听事件。先看下javapoet提供的几个方法或类:</p>
<h5 id="1-MethodSpec：生成方法的辅助类"><a href="#1-MethodSpec：生成方法的辅助类" class="headerlink" title="1.MethodSpec：生成方法的辅助类"></a>1.MethodSpec：生成方法的辅助类</h5><p>这里主要是生成构造函数，当然也可以生成其它的普通方法，构造函数也是方法的一种吗。<br>通过constructorBuilder构造出一个方法,通过addAnnotation添加注解，通过addModifiers添加修饰符。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MethodSpec.Builder constructor = </span><br><span class="line"> MethodSpec.constructorBuilder()</span><br><span class="line">       .addAnnotation(UI_THREAD)</span><br><span class="line">       .addModifiers(PUBLIC);</span><br></pre></td></tr></table></figure>

<p>通过如下方法添加参数targetType为参数类型，”target”为参数的变量名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">constructor.addParameter(targetType, <span class="string">&quot;target&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>通过如下方法添加代码语句<br>第一参数是String类型，可以有占位符S（字符串类型），T（类型）等<br>第二个参数Object… args，类型，多参数不固定。<br>就像你平时使用String.format()方法一样的意思.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">constructor.addStatement(<span class="string">&quot;this.target = target&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="2-构造函数中变量的赋值"><a href="#2-构造函数中变量的赋值" class="headerlink" title="2.构造函数中变量的赋值"></a>2.构造函数中变量的赋值</h5><p>这里主要是对使用了如下的代码进行一个赋值操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindView(R2.id.title)</span> </span><br><span class="line">TextView title;</span><br></pre></td></tr></table></figure>

<p>这里我们主要看一下关键方法，因为都是类似的拼接代码字符串。<br>我们看一下变量的赋值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addViewBindings</span><span class="params">(MethodSpec.Builder result, ViewBindings bindings)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bindings.isSingleFieldBinding()) &#123;</span><br><span class="line">    <span class="comment">// Optimize the common case where there&#x27;s a single binding directly to a field.</span></span><br><span class="line">    FieldViewBinding fieldBinding = bindings.getFieldBinding();</span><br><span class="line">    CodeBlock.Builder builder = CodeBlock.builder()</span><br><span class="line">        .add(<span class="string">&quot;target.$L = &quot;</span>, fieldBinding.getName());</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">boolean</span> requiresCast = requiresCast(fieldBinding.getType());</span><br><span class="line">    <span class="keyword">if</span> (!requiresCast &amp;&amp; !fieldBinding.isRequired()) &#123;</span><br><span class="line">      builder.add(<span class="string">&quot;source.findViewById($L)&quot;</span>, bindings.getId().code);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      builder.add(<span class="string">&quot;$T.find&quot;</span>, UTILS);</span><br><span class="line">      builder.add(fieldBinding.isRequired() ? <span class="string">&quot;RequiredView&quot;</span> : <span class="string">&quot;OptionalView&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">        builder.add(<span class="string">&quot;AsType&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      builder.add(<span class="string">&quot;(source, $L&quot;</span>, bindings.getId().code);</span><br><span class="line">      <span class="keyword">if</span> (fieldBinding.isRequired() || requiresCast) &#123;</span><br><span class="line">        builder.add(<span class="string">&quot;, $S&quot;</span>, asHumanDescription(singletonList(fieldBinding)));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (requiresCast) &#123;</span><br><span class="line">        builder.add(<span class="string">&quot;, $T.class&quot;</span>, fieldBinding.getRawType());</span><br><span class="line">      &#125;</span><br><span class="line">      builder.add(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    result.addStatement(<span class="string">&quot;$L&quot;</span>, builder.build());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  List&lt;ViewBinding&gt; requiredViewBindings = bindings.getRequiredBindings();</span><br><span class="line">  <span class="keyword">if</span> (requiredViewBindings.isEmpty()) &#123;</span><br><span class="line">    result.addStatement(<span class="string">&quot;view = source.findViewById($L)&quot;</span>, bindings.getId().code);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!bindings.isBoundToRoot()) &#123;</span><br><span class="line">    result.addStatement(<span class="string">&quot;view = $T.findRequiredView(source, $L, $S)&quot;</span>, UTILS,</span><br><span class="line">        bindings.getId().code, asHumanDescription(requiredViewBindings));</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  addFieldBindings(result, bindings);</span><br><span class="line">  addMethodBindings(result, bindings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是调用系统的findViewById 方法，但是你看到了findRequiredViewAsType,findRequiredView方法和castView方法，findRequiredView,findRequiredViewAsType是作者为乐代码的书写方便对findViewById的一层封装，你可以看一下源码,最后都会调用的findRequiredView方法的findViewById方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> View <span class="title">findRequiredView</span><span class="params">(View source, <span class="meta">@IdRes</span> <span class="keyword">int</span> id, String who)</span> </span>&#123;</span><br><span class="line">   View view = source.findViewById(id);</span><br><span class="line">   <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> view;</span><br><span class="line">   &#125;</span><br><span class="line">   String name = getResourceEntryName(source, id);</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Required view &#x27;&quot;</span></span><br><span class="line">       + name</span><br><span class="line">       + <span class="string">&quot;&#x27; with ID &quot;</span></span><br><span class="line">       + id</span><br><span class="line">       + <span class="string">&quot; for &quot;</span></span><br><span class="line">       + who</span><br><span class="line">       + <span class="string">&quot; was not found. If this view is optional add &#x27;@Nullable&#x27; (fields) or &#x27;@Optional&#x27;&quot;</span></span><br><span class="line">       + <span class="string">&quot; (methods) annotation.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个castView是什么方法呢？是Class类的方法，直接转换为指定的类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">castView</span><span class="params">(View view, <span class="meta">@IdRes</span> <span class="keyword">int</span> id, String who, Class&lt;T&gt; cls)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> cls.cast(view);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">     String name = getResourceEntryName(view, id);</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;View &#x27;&quot;</span></span><br><span class="line">         + name</span><br><span class="line">         + <span class="string">&quot;&#x27; with ID &quot;</span></span><br><span class="line">         + id</span><br><span class="line">         + <span class="string">&quot; for &quot;</span></span><br><span class="line">         + who</span><br><span class="line">         + <span class="string">&quot; was of the wrong type. See cause for more info.&quot;</span>, e);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>说白了都是调用系统的方法。<br>好了到这里成员变量的赋值算是完了。<br>注意一点target.title target就是我们的activity或者view ；也验证了为什么是使用了类似BindView注解不能是private修饰符的另一个         原因了。</p>
<p>感兴趣的可以根据生成的代码来对照这查看，这里就不多说了。<br>最后生成的如下所示的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UiThread</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SimpleActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> T target, View source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.target = target;</span><br><span class="line"></span><br><span class="line">    View view;</span><br><span class="line">    target.title = Utils.findRequiredViewAsType(source, R.id.title, <span class="string">&quot;field &#x27;title&#x27;&quot;</span>, TextView.class);</span><br><span class="line">    target.subtitle = Utils.findRequiredViewAsType(source, R.id.subtitle, <span class="string">&quot;field &#x27;subtitle&#x27;&quot;</span>, TextView.class);</span><br><span class="line">    view = Utils.findRequiredView(source, R.id.hello, <span class="string">&quot;field &#x27;hello&#x27;, method &#x27;sayHello&#x27;, and method &#x27;sayGetOffMe&#x27;&quot;</span>);</span><br><span class="line">    target.hello = Utils.castView(view, R.id.hello, <span class="string">&quot;field &#x27;hello&#x27;&quot;</span>, Button.class);</span><br><span class="line">    view2130968578 = view;</span><br><span class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</span><br><span class="line">        target.sayHello();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    view.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View p0)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target.sayGetOffMe();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    view = Utils.findRequiredView(source, R.id.list_of_things, <span class="string">&quot;field &#x27;listOfThings&#x27; and method &#x27;onItemClick&#x27;&quot;</span>);</span><br><span class="line">    target.listOfThings = Utils.castView(view, R.id.list_of_things, <span class="string">&quot;field &#x27;listOfThings&#x27;&quot;</span>, ListView.class);</span><br><span class="line">    view2130968579 = view;</span><br><span class="line">    ((AdapterView&lt;?&gt;) view).setOnItemClickListener(<span class="keyword">new</span> AdapterView.OnItemClickListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; p0, View p1, <span class="keyword">int</span> p2, <span class="keyword">long</span> p3)</span> </span>&#123;</span><br><span class="line">        target.onItemClick(p2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    target.footer = Utils.findRequiredViewAsType(source, R.id.footer, <span class="string">&quot;field &#x27;footer&#x27;&quot;</span>, TextView.class);</span><br><span class="line">    target.headerViews = Utils.listOf(</span><br><span class="line">        Utils.findRequiredView(source, R.id.title, <span class="string">&quot;field &#x27;headerViews&#x27;&quot;</span>), </span><br><span class="line">        Utils.findRequiredView(source, R.id.subtitle, <span class="string">&quot;field &#x27;headerViews&#x27;&quot;</span>), </span><br><span class="line">        Utils.findRequiredView(source, R.id.hello, <span class="string">&quot;field &#x27;headerViews&#x27;&quot;</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h4 id="（三）生成unbind方法"><a href="#（三）生成unbind方法" class="headerlink" title="（三）生成unbind方法"></a>（三）生成unbind方法</h4><p>createBindingUnbindMethod方法主要是把的成员变量啦，Listener等 置为空，比如setOnClickListener（null）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingUnbindMethod</span><span class="params">(TypeSpec.Builder bindingClass,</span></span></span><br><span class="line"><span class="params"><span class="function">      TypeName targetType)</span> </span>&#123;</span><br><span class="line">    MethodSpec.Builder result = MethodSpec.methodBuilder(<span class="string">&quot;unbind&quot;</span>)</span><br><span class="line">        .addAnnotation(Override.class)</span><br><span class="line">        .addModifiers(PUBLIC);</span><br><span class="line">    <span class="keyword">if</span> (!isFinal &amp;&amp; !hasParentBinding()) &#123;</span><br><span class="line">      result.addAnnotation(CALL_SUPER);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> rootBindingWithFields = !hasParentBinding() &amp;&amp; hasFieldBindings();</span><br><span class="line">    <span class="keyword">if</span> (hasFieldBindings() || rootBindingWithFields) &#123;</span><br><span class="line">      result.addStatement(<span class="string">&quot;$T target = this.target&quot;</span>, targetType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!hasParentBinding()) &#123;</span><br><span class="line">      String target = rootBindingWithFields ? <span class="string">&quot;target&quot;</span> : <span class="string">&quot;this.target&quot;</span>;</span><br><span class="line">      result.addStatement(<span class="string">&quot;if ($N == null) throw new $T($S)&quot;</span>, target, IllegalStateException.class,</span><br><span class="line">          <span class="string">&quot;Bindings already cleared.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.addStatement(<span class="string">&quot;super.unbind()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasFieldBindings()) &#123;</span><br><span class="line">      result.addCode(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (ViewBindings bindings : viewIdMap.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bindings.getFieldBinding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">          result.addStatement(<span class="string">&quot;target.$L = null&quot;</span>, bindings.getFieldBinding().getName());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (FieldCollectionViewBinding fieldCollectionBinding : collectionBindings.keySet()) &#123;</span><br><span class="line">        result.addStatement(<span class="string">&quot;target.$L = null&quot;</span>, fieldCollectionBinding.getName());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasMethodBindings()) &#123;</span><br><span class="line">      result.addCode(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (ViewBindings bindings : viewIdMap.values()) &#123;</span><br><span class="line">        addFieldAndUnbindStatement(bindingClass, result, bindings);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!hasParentBinding()) &#123;</span><br><span class="line">      result.addCode(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">      result.addStatement(<span class="string">&quot;this.target = null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result.build();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>主要就是addStatement方法，上文已经说了，该方法的意思就是生成一句代码，<br>第一参数是String类型，可以有占位符S（字符串类型），<br>T（类型）等<br>第二个参数Object… args，类型，多参数不固定。<br>就像你平时使用String.format()方法一样的意思.<br>比较简单，最后生成的方法类似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  SimpleAdapter.ViewHolder target = <span class="keyword">this</span>.target;</span><br><span class="line">  <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Bindings already cleared.&quot;</span>);</span><br><span class="line"></span><br><span class="line">  target.word = <span class="keyword">null</span>;</span><br><span class="line">  target.length = <span class="keyword">null</span>;</span><br><span class="line">  target.position = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.target = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此我们整个的流程算分析完了。</p>
<p>最后我们看下对外提供的API</p>
<h3 id="bind-方法"><a href="#bind-方法" class="headerlink" title="bind 方法"></a>bind 方法</h3><p>那么还差一步，什么时候使用我们生成的java文件呢？答案是：<br>ButterKnife.bind(this);方法。<br>我们看一下ButterKnife对外提供的API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> Activity&#125;. The current content</span></span><br><span class="line"><span class="comment"> * view is used as the view root.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target Target activity for view binding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> Activity target)</span> </span>&#123;</span><br><span class="line">  View sourceView = target.getWindow().getDecorView();</span><br><span class="line">  <span class="keyword">return</span> createBinding(target, sourceView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> View&#125;. The view and its children</span></span><br><span class="line"><span class="comment"> * are used as the view root.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target Target view for view binding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> View target)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createBinding(target, target);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BindView annotated fields and methods in the specified &#123;<span class="doctag">@link</span> Dialog&#125;. The current content</span></span><br><span class="line"><span class="comment"> * view is used as the view root.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target Target dialog for view binding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> Dialog target)</span> </span>&#123;</span><br><span class="line">  View sourceView = target.getWindow().getDecorView();</span><br><span class="line">  <span class="keyword">return</span> createBinding(target, sourceView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BindView annotated fields and methods in the specified &#123;<span class="doctag">@code</span> target&#125; using the &#123;<span class="doctag">@code</span> source&#125;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Activity&#125; as the view root.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target Target class for view binding.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> source Activity on which IDs will be looked up.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> Object target, <span class="meta">@NonNull</span> Activity source)</span> </span>&#123;</span><br><span class="line">  View sourceView = source.getWindow().getDecorView();</span><br><span class="line">  <span class="keyword">return</span> createBinding(target, sourceView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BindView annotated fields and methods in the specified &#123;<span class="doctag">@code</span> target&#125; using the &#123;<span class="doctag">@code</span> source&#125;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> View&#125; as the view root.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target Target class for view binding.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> source View root on which IDs will be looked up.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> Object target, <span class="meta">@NonNull</span> View source)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createBinding(target, source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BindView annotated fields and methods in the specified &#123;<span class="doctag">@code</span> target&#125; using the &#123;<span class="doctag">@code</span> source&#125;</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Dialog&#125; as the view root.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target Target class for view binding.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> source Dialog on which IDs will be looked up.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(<span class="meta">@NonNull</span> Object target, <span class="meta">@NonNull</span> Dialog source)</span> </span>&#123;</span><br><span class="line">  View sourceView = source.getWindow().getDecorView();</span><br><span class="line">  <span class="keyword">return</span> createBinding(target, sourceView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(<span class="meta">@NonNull</span> Object target, <span class="meta">@NonNull</span> View source)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取类的实例</span></span><br><span class="line">  Class&lt;?&gt; targetClass = target.getClass();</span><br><span class="line">  <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;Looking up binding for &quot;</span> + targetClass.getName());</span><br><span class="line">  <span class="comment">//获取构造函数</span></span><br><span class="line">  Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Unbinder.EMPTY;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//最后constructor.newInstance方法来调用该类的构造函数</span></span><br><span class="line">    <span class="keyword">return</span> constructor.newInstance(target, source);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to invoke &quot;</span> + constructor, e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to invoke &quot;</span> + constructor, e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">    Throwable cause = e.getCause();</span><br><span class="line">    <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">      <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to create binding instance.&quot;</span>, cause);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到bind的一系列方法都会调用createBinding方法</p>
<p>而该类的构造函数是通过findBindingConstructorForClass方法，我们可以看下此方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</span><br><span class="line">  <span class="comment">//缓存中查找，找到直接返回</span></span><br><span class="line">    Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);</span><br><span class="line">    <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;HIT: Cached in binding map.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> bindingCtor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//检查合法性</span></span><br><span class="line">    String clsName = cls.getName();</span><br><span class="line">    <span class="keyword">if</span> (clsName.startsWith(<span class="string">&quot;android.&quot;</span>) || clsName.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;MISS: Reached framework class. Abandoning search.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//构造一个class，可以看类名就是我们生成的。</span></span><br><span class="line">      Class&lt;?&gt; bindingClass = Class.forName(clsName + <span class="string">&quot;_ViewBinding&quot;</span>);</span><br><span class="line">      <span class="comment">//noinspection unchecked</span></span><br><span class="line">        <span class="comment">// 获取我们的构造函数</span></span><br><span class="line">      bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;HIT: Loaded binding class and constructor.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">&quot;Not found. Trying superclass &quot;</span> + cls.getSuperclass().getName());</span><br><span class="line">      bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to find binding constructor for &quot;</span> + clsName, e);</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//加入到缓存中</span></span><br><span class="line">    BINDINGS.put(cls, bindingCtor);</span><br><span class="line">    <span class="keyword">return</span> bindingCtor;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到用到了简单的map缓存。</p>
<h3 id="unbind-方法"><a href="#unbind-方法" class="headerlink" title="unbind 方法"></a>unbind 方法</h3><p>在8.4.0版本中去除了 unbind方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ButterKnife.unbind(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>

<p>采用了接口的形式。让生成的类来实现，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAdapter</span>$<span class="title">ViewHolder_ViewBinding</span> <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</span><br><span class="line">  <span class="meta">@UiThread</span></span><br><span class="line"> <span class="keyword">public</span> SimpleAdapter$ViewHolder_ViewBinding(SimpleAdapter.ViewHolder target, View source) &#123;</span><br><span class="line"> <span class="comment">//...</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> /...</span><br><span class="line"> &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>

<p>那如何unbind呢？？<br>ButterKnife.bind(this)返回值是一个我们生成的java文件类的实例对象。返回的是一个Unbinder 正和此意。<br>so，你可以这么用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>  Unbinder unbinder;     </span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.simple_activity);</span><br><span class="line">     unbinder=ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line">     ｝</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    unbinder.unbind();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>到此我们整个ButterKnife的@BindView处理流程的分析就算完了。</p>
<p>接下来的最后一章节我们会自己实现一个简易版本的ButterKnife的@BindView方法。</p>
<p>如果大家觉得这篇源码分析系列文章写得还好的话 给个star也行呗~~  <a target="_blank" rel="noopener" href="https://github.com/tomridder/ButterKnife-8.4.0-">github地址传送门</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/" data-id="ckz8hfzwn0005p4v62acbg55v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BA%94%EF%BC%89/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ButterKnife源码解析（五）
        
      </div>
    </a>
  
  
    <a href="/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ButterKnife源码解析（三）</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/02/04/ButterKnife-8-4-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/">ButterKnife 8.4.0 源码解析系列文章</a>
          </li>
        
          <li>
            <a href="/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BA%94%EF%BC%89/">ButterKnife源码解析（五）</a>
          </li>
        
          <li>
            <a href="/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/">ButterKnife源码解析（四）</a>
          </li>
        
          <li>
            <a href="/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/">ButterKnife源码解析（三）</a>
          </li>
        
          <li>
            <a href="/2022/02/03/ButterKnife%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/">ButterKnife源码解析（二）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>